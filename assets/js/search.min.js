const __ensureMount = () => {
  let el = document.querySelector('[data-search-results]');
  if (el) return el;
  const main = document.querySelector('main') || document.querySelector('#konten') || document.body;
  el = document.createElement('div');
  el.className = 'search-results';
  el.setAttribute('data-search-results','');
  main.appendChild(el);
  return el;
};
(function(){
  let index = window.SEARCH_INDEX || [];
  window.addEventListener('search:index:ready', () => {
    index = window.SEARCH_INDEX || [];
    try{
      const input = document.getElementById('search-page-input');
      const q = (input && input.value) ? input.value : (new URLSearchParams(window.location.search).get('q') || '');
      if (document.getElementById('search-results')) {
        const evt = new CustomEvent('search:rerender', { detail: { q } });
        window.dispatchEvent(evt);
      }
    }catch(e){}
  });
  function getRootPrefix(){
    try{
      const depth = Math.max(0, window.location.pathname.split('/').length - 2);
      return '../'.repeat(depth);
    }catch(e){
      return '';
    }
  }
  const ROOT_PREFIX = getRootPrefix();
  const normalize = (s) => (s || '').toString().toLowerCase();
  function escapeHTML(s){
    return (s ?? '').toString()
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#39;");
  }
  function scoreItem(q, item){
    const qq = normalize(q);
    const title = normalize(item.title);
    const ex = normalize(item.excerpt);
    const tags = (item.tags || []).map(normalize).join(' ');
    const cat = normalize(item.category);
    let score = 0;
    if (title.includes(qq)) score += 6;
    if (ex.includes(qq)) score += 3;
    if (tags.includes(qq)) score += 2;
    if (cat.includes(qq)) score += 1;
    if (title.startsWith(qq)) score += 2;
    return score;
  }
  function search(q){
    const qq = q.trim();
    if (!qq) return [];
    const out = [];
    for (const item of index){
      const s = scoreItem(qq, item);
      if (s > 0) out.push({item, s});
    }
    out.sort((a,b)=>b.s-a.s);
    return out.map(x=>x.item);
  }
  function bindNavbarSuggest(){
    const navInput = document.querySelector('.nav-search-input');
    const suggest = document.querySelector('[data-search-suggest]');
    if (!navInput || !suggest) return;
    if (navInput.dataset.bound === '1') return;
    navInput.dataset.bound = '1';
    function closeSuggest(){
      suggest.classList.remove('open');
      suggest.innerHTML = '';
    }
    function openSuggest(){
      suggest.classList.add('open');
    }
    function renderSuggest(items){
      if (!items.length){
        suggest.innerHTML = `<div class="search-item"><div><p class="t">Tidak ada hasil</p><p class="m">Coba kata kunci lain.</p></div></div>`;
        openSuggest();
        return;
      }
      const top = items.slice(0,6);
      suggest.innerHTML = top.map(it => {
                const href = escapeHTML(ROOT_PREFIX + (it.url || ''));
                const descRaw = (it.excerpt || '').slice(0, 120);
        const desc = escapeHTML(descRaw);
        const title = escapeHTML(it.title || '');
                const badges = [it.category, it.date]
          .filter(Boolean)
          .map(x => `<span class="search-badge">${escapeHTML(x)}</span>`)
          .join('');
        return `
          <a class="search-item" href="${href}">
            <div>
              <p class="t">${title}</p>
              <p class="m">${desc}${desc.length>=120?'…':''}</p>
              <div class="b">${badges}</div>
            </div>
          </a>
        `;
      }).join('');
      openSuggest();
    }
    let t = null;
    navInput.addEventListener('input', () => {
      clearTimeout(t);
      const q = navInput.value.trim();
      if (q.length < 2){
        closeSuggest();
        return;
      }
      t = setTimeout(() => renderSuggest(search(q)), 120);
    });
    navInput.addEventListener('focus', () => {
      const q = navInput.value.trim();
      if (q.length >= 2) renderSuggest(search(q));
    });
    if (!window.__IKSASS_SEARCH_GLOBALS){
      window.__IKSASS_SEARCH_GLOBALS = true;
      document.addEventListener('pointerdown', (e) => {
        const wrap = navInput.closest('.nav-search');
        if (!wrap) return;
        if (!wrap.contains(e.target)) closeSuggest();
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeSuggest();
      });
    }
  }
  function initSearchPage(){
    const pageInput = document.getElementById('search-page-input');
    const pageBtn = document.getElementById('search-page-btn');
    const resultsEl = document.getElementById('search-results');
    function renderResults(q){
      if (!resultsEl) return;
      const items = search(q);
            const safeQ = (q||'').trim();
      const safeQEsc = escapeHTML(safeQ);
      if (!safeQ){
        resultsEl.innerHTML = '';
        return;
      }
      if (!items.length){
        resultsEl.innerHTML = `<div class="search-card"><p class="title">Tidak ada hasil</p><p class="desc">Tidak ditemukan konten untuk kata kunci <b>${safeQEsc}</b>.</p></div>`;
        return;
      }
      resultsEl.innerHTML = items.map(it => {
                const href = escapeHTML(ROOT_PREFIX + (it.url || ''));
                const meta = escapeHTML([it.category, it.date].filter(Boolean).join(' • '));
                const desc = escapeHTML(it.excerpt || '');
        const title = escapeHTML(it.title || '');
        return `
          <a class="search-card" href="${href}">
            <p class="title">${title}</p>
            ${meta ? `<p class="meta">${meta}</p>` : ''}
            ${desc ? `<p class="desc">${desc}</p>` : ''}
          </a>
        `;
      }).join('');
    }
    if (!window.__IKSASS_SEARCH_RERENDER_BOUND){
      window.__IKSASS_SEARCH_RERENDER_BOUND = true;
      window.addEventListener('search:rerender', (e) => {
        try{
          const q = (e && e.detail && typeof e.detail.q === 'string') ? e.detail.q : '';
          renderResults(q);
        }catch(err){}
      });
    }
    try{
      const params = new URLSearchParams(window.location.search);
      const q = params.get('q') || '';
      if (pageInput){
        pageInput.value = q;
        renderResults(q);
        if (!pageInput.dataset.bound){
          pageInput.dataset.bound = '1';
          pageInput.addEventListener('keydown', (e)=>{
            if (e.key === 'Enter') renderResults(pageInput.value);
          });
        }
      }
      if (pageBtn && pageInput && !pageBtn.dataset.bound){
        pageBtn.dataset.bound = '1';
        pageBtn.addEventListener('click', ()=>renderResults(pageInput.value));
      }
    }catch(e){}
  }
  bindNavbarSuggest();
  document.addEventListener('partials:loaded', bindNavbarSuggest);
  document.addEventListener('DOMContentLoaded', () => {
    bindNavbarSuggest();
    initSearchPage();
  });
})();