(() => {
  const CACHE_VERSION="1771210001";
  const getRootPrefix = () => {
    const parts = (location.pathname || "/").split("/").filter(Boolean);
    const last = parts[parts.length - 1] || "";
    if (last.includes(".")) parts.pop(); // file path
    return "../".repeat(Math.max(0, parts.length));
  };
  const applyRoot = (html, root) => (html || "").split("{{root}}").join(root);
  const enhanceBeritaMega = (rootPrefix) => {
    const mega = document.querySelector(".berita-mega .mega-posts");
    if (!mega) return;
    const indexUrl = `${rootPrefix}berita/news-index.json`;
    fetch(indexUrl, { cache: "no-store" })
      .then(r => (r.ok ? r.json() : Promise.reject()))
      .then((list) => {
        const bySlug = new Map((list || []).map(it => [String(it.slug || ""), it]));
        mega.querySelectorAll("a.mega-card").forEach((card) => {
          const href = card.getAttribute("href") || "";
          const m = href.match(/berita\/([^\/]+)\/?$/);
          const slug = m ? m[1] : "";
          const item = bySlug.get(slug);
          if (!item) return;
          const body = card.querySelector(".mega-card-body");
          if (!body) return;
          if (!body.querySelector(".mega-card-snippet, .mega-card-excerpt") && item.excerpt) {
            const ex = document.createElement("div");
            ex.className = "mega-card-snippet mega-card-excerpt";
            ex.textContent = item.excerpt;
            body.appendChild(ex);
          }
          const meta = body.querySelector(".mega-card-meta");
          if (meta && item.date_display) meta.textContent = item.date_display;
        });
      })
      .catch(() => {
      });
  };
  const cacheKey = (name) => `iksass:${CACHE_VERSION}:partial:raw:${name}`;
  const ensureScript = (src, key) => {
    try {
      const abs = new URL(src, location.href).href;
      const existing = Array.from(document.querySelectorAll('script[src]'))
        .some(s => new URL(s.getAttribute('src'), location.href).href === abs);
      if (existing) return;
      if (key && document.querySelector(`script[data-iksass="${key}"]`)) return;
      const s = document.createElement('script');
      if (key) s.dataset.iksass = key;
      s.src = src;
      s.defer = true;
      document.head.appendChild(s);
    } catch {
    }
  };
const setHTMLAll = (holders, html, removeAttr = true) => {
    holders.forEach((holder) => {
      holder.innerHTML = html;
      if (removeAttr) holder.removeAttribute("data-include");
      holder.style.minHeight = "0";
    });
  };
  const injectAll = async (name, root) => {
    const holders = Array.from(document.querySelectorAll(`[data-include="${name}"]`));
    if (!holders.length) return false;
    try {
      const cachedRaw = localStorage.getItem(cacheKey(name));
      if (cachedRaw) {
        const cached = applyRoot(cachedRaw, root);
        setHTMLAll(holders, cached, false);
              if (name === "header") enhanceBeritaMega(root);
}
    } catch {
    }
    try {
      const res = await fetch(`/partials/${name}.html`, { cache: "no-store" });
      if (!res.ok) return false;
      const raw = await res.text();
      const html = applyRoot(raw, root);
      const first = holders[0];
      const current = (first && first.innerHTML) || "";
      if (current !== html) setHTMLAll(holders, html, true);
            if (name === "header") enhanceBeritaMega(root);
else {
        holders.forEach((h) => h.removeAttribute("data-include"));
      }
            if (name === "header") enhanceBeritaMega(root);
      try {
        localStorage.setItem(cacheKey(name), raw);
      } catch {
      }
      return true;
    } catch {
      return false;
    }
  };
  (async () => {
    const root = getRootPrefix();
    await await Promise.all([injectAll("header", root), injectAll("footer", root)]);
    ensureScript(`${root}assets/js/main.js`, "main");
    document.dispatchEvent(new CustomEvent("partials:loaded"));
  })();
})();